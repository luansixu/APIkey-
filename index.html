<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI API å¯†é’¥å…¨èƒ½æµ‹è¯•å·¥å…·</title>
    <style>
        :root {
            --primary: #4285f4;
            --primary-dark: #3367d6;
            --success: #0f9d58;
            --warning: #f4b400;
            --danger: #db4437;
            --bg: #0f1117;
            --bg-card: #1a1d27;
            --bg-input: #252830;
            --border: #2e3140;
            --text: #e8eaed;
            --text-secondary: #9aa0a6;
            --radius: 12px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1100px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Header */
        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: 700;
            background: linear-gradient(135deg, #4285f4, #ea4335, #fbbc04, #34a853);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 1rem;
        }

        /* Input Section */
        .input-section {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 28px;
            margin-bottom: 28px;
        }

        .input-group {
            display: flex;
            gap: 12px;
            align-items: stretch;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper input {
            width: 100%;
            padding: 14px 48px 14px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: 'Consolas', 'Courier New', monospace;
            transition: border-color 0.2s;
            outline: none;
        }

        .input-wrapper input:focus {
            border-color: var(--primary);
        }

        .input-wrapper input::placeholder {
            color: var(--text-secondary);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .toggle-visibility {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            font-size: 1.1rem;
            line-height: 1;
        }

        .toggle-visibility:hover {
            color: var(--text);
        }

        .btn-test {
            padding: 14px 32px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-test:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-test:active:not(:disabled) {
            transform: scale(0.97);
        }

        .btn-test:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-test .spinner {
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: none;
        }

        .btn-test.loading .spinner {
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Options */
        .options-row {
            display: flex;
            gap: 20px;
            margin-top: 16px;
            flex-wrap: wrap;
            align-items: center;
        }

        .option-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .option-item label {
            font-size: 0.88rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        .option-item select {
            padding: 6px 10px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            outline: none;
        }

        .option-item select:focus {
            border-color: var(--primary);
        }

        .checkbox-wrapper {
            position: relative;
            display: inline-flex;
            align-items: center;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--primary);
            cursor: pointer;
        }

        /* Status Bar */
        .status-bar {
            display: none;
            align-items: center;
            gap: 10px;
            padding: 14px 20px;
            border-radius: var(--radius);
            margin-bottom: 24px;
            font-size: 0.9rem;
            border: 1px solid;
        }

        .status-bar.show { display: flex; }

        .status-bar.success {
            background: rgba(15,157,88,0.1);
            border-color: rgba(15,157,88,0.3);
            color: #81c995;
        }

        .status-bar.error {
            background: rgba(219,68,55,0.1);
            border-color: rgba(219,68,55,0.3);
            color: #f28b82;
        }

        .status-bar.info {
            background: rgba(66,133,244,0.1);
            border-color: rgba(66,133,244,0.3);
            color: #8ab4f8;
        }

        .status-icon {
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        /* Summary Cards */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-bottom: 28px;
        }

        .summary-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            text-align: center;
        }

        .summary-card .number {
            font-size: 2rem;
            font-weight: 700;
            line-height: 1.2;
        }

        .summary-card .label {
            font-size: 0.82rem;
            color: var(--text-secondary);
            margin-top: 4px;
        }

        .summary-card.total .number { color: var(--primary); }
        .summary-card.generate .number { color: var(--success); }
        .summary-card.embed .number { color: var(--warning); }
        .summary-card.other .number { color: #a142f4; }

        /* Filter & Search */
        .toolbar {
            display: flex;
            gap: 12px;
            margin-bottom: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .search-box {
            flex: 1;
            min-width: 200px;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.9rem;
            outline: none;
        }

        .search-box:focus {
            border-color: var(--primary);
        }

        .filter-btn {
            padding: 8px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            border-color: var(--primary);
            color: var(--text);
        }

        .filter-btn.active {
            background: var(--primary);
            border-color: var(--primary);
            color: #fff;
        }

        /* Models Grid */
        .models-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(340px, 1fr));
            gap: 16px;
        }

        .model-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 22px;
            transition: border-color 0.2s, transform 0.15s;
            position: relative;
            overflow: hidden;
        }

        .model-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }

        .model-card .model-name {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
            color: var(--text);
            word-break: break-all;
        }

        .model-card .model-id {
            font-size: 0.78rem;
            color: var(--text-secondary);
            font-family: 'Consolas', monospace;
            margin-bottom: 12px;
            word-break: break-all;
        }

        .model-card .model-desc {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 14px;
            line-height: 1.5;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-bottom: 14px;
        }

        .tag {
            padding: 3px 10px;
            border-radius: 20px;
            font-size: 0.72rem;
            font-weight: 500;
        }

        .tag.generate {
            background: rgba(15,157,88,0.15);
            color: #81c995;
        }

        .tag.embed {
            background: rgba(244,180,0,0.15);
            color: #fdd663;
        }

        .tag.tune {
            background: rgba(161,66,244,0.15);
            color: #c58af9;
        }

        .tag.count {
            background: rgba(66,133,244,0.15);
            color: #8ab4f8;
        }

        .tag.other-method {
            background: rgba(100,100,100,0.2);
            color: var(--text-secondary);
        }

        .model-meta {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            font-size: 0.8rem;
        }

        .meta-item {
            display: flex;
            flex-direction: column;
        }

        .meta-item .meta-label {
            color: var(--text-secondary);
            font-size: 0.72rem;
        }

        .meta-item .meta-value {
            color: var(--text);
            font-weight: 500;
        }

        /* Test button on card */
        .btn-test-model {
            margin-top: 14px;
            width: 100%;
            padding: 8px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.82rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-test-model:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: rgba(66,133,244,0.05);
        }

        .btn-test-model.testing {
            color: var(--warning);
            border-color: rgba(244,180,0,0.3);
        }

        .btn-test-model.test-success {
            color: var(--success);
            border-color: rgba(15,157,88,0.3);
            background: rgba(15,157,88,0.05);
        }

        .btn-test-model.test-fail {
            color: var(--danger);
            border-color: rgba(219,68,55,0.3);
            background: rgba(219,68,55,0.05);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state .icon {
            font-size: 3rem;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-state h3 {
            font-size: 1.1rem;
            margin-bottom: 8px;
            color: var(--text);
        }

        /* Proxy Section */
        .proxy-section {
            margin-top: 12px;
        }

        .proxy-toggle {
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .proxy-toggle:hover {
            color: var(--text);
        }

        .proxy-inputs {
            display: none;
            margin-top: 10px;
            gap: 12px;
        }

        .proxy-inputs.show {
            display: flex;
            flex-wrap: wrap;
        }

        .proxy-inputs input {
            flex: 1;
            min-width: 250px;
            padding: 10px 14px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.88rem;
            outline: none;
            font-family: 'Consolas', monospace;
        }

        .proxy-inputs input:focus {
            border-color: var(--primary);
        }

        .proxy-hint {
            font-size: 0.78rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        /* Responsive */
        @media (max-width: 640px) {
            .input-group {
                flex-direction: column;
            }

            .models-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .summary {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        /* Fade in animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(12px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .model-card {
            animation: fadeInUp 0.3s ease forwards;
        }

        /* Chat / Prompt Area */
        .chat-area {
            margin-top: 14px;
            border-top: 1px solid var(--border);
            padding-top: 14px;
        }

        .chat-input-row {
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 9px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.84rem;
            outline: none;
            resize: none;
            font-family: inherit;
            min-height: 38px;
            max-height: 100px;
        }

        .chat-input:focus {
            border-color: var(--primary);
        }

        .chat-input::placeholder {
            color: var(--text-secondary);
        }

        .btn-send {
            padding: 9px 16px;
            background: var(--primary);
            color: #fff;
            border: none;
            border-radius: 6px;
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s, opacity 0.2s;
            white-space: nowrap;
            align-self: flex-end;
        }

        .btn-send:hover:not(:disabled) {
            background: var(--primary-dark);
        }

        .btn-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-response {
            margin-top: 10px;
            padding: 12px 14px;
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 0.84rem;
            line-height: 1.6;
            color: var(--text);
            display: none;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .chat-response.show {
            display: block;
        }

        .chat-response.loading {
            color: var(--text-secondary);
            font-style: italic;
        }

        .chat-response.error {
            color: #f28b82;
            border-color: rgba(219,68,55,0.3);
            background: rgba(219,68,55,0.05);
        }

        .chat-response .response-label {
            display: block;
            font-size: 0.72rem;
            color: var(--text-secondary);
            margin-bottom: 6px;
            font-style: normal;
        }

        .chat-response .response-text {
            font-style: normal;
        }

        .chat-response .response-meta {
            display: block;
            font-size: 0.7rem;
            color: var(--text-secondary);
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid var(--border);
            font-style: normal;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #4a4d5a;
        }

        .results-section {
            display: none;
        }

        .results-section.show {
            display: block;
        }

        /* â”€â”€â”€ Manual Provider Selector â”€â”€â”€ */
        .manual-provider-selector {
            margin-top: 24px; padding: 24px;
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 16px;
        }
        .manual-provider-selector h3 { margin: 0 0 8px; font-size: 1.1rem; }
        .manual-provider-selector p { margin: 0 0 16px; color: var(--text-secondary); font-size: 0.9rem; }
        .provider-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 10px; margin-bottom: 16px;
        }
        .provider-btn {
            display: flex; align-items: center; gap: 8px;
            padding: 12px 16px; background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.1);
            border-radius: 10px; color: var(--text-primary); cursor: pointer; font-size: 0.9rem;
            transition: all 0.2s;
        }
        .provider-btn:hover {
            background: rgba(99,102,241,0.15); border-color: var(--primary); transform: translateY(-1px);
        }
        .provider-btn .p-icon { font-size: 1.2rem; }
        .provider-btn .p-name { font-weight: 600; }
        .provider-btn .p-url { font-size: 0.72rem; color: var(--text-secondary); word-break: break-all; }
        .custom-url-row {
            display: flex; gap: 10px; align-items: center;
        }
        .custom-url-row input {
            flex: 1; padding: 10px 14px; border-radius: 8px; border: 1px solid var(--border);
            background: var(--bg-secondary); color: var(--text-primary); font-size: 0.9rem;
        }
        .custom-url-row .btn-primary {
            padding: 10px 20px; border-radius: 8px; border: none;
            background: var(--primary); color: #fff; font-weight: 600; cursor: pointer;
            white-space: nowrap;
        }
        .custom-url-row .btn-primary:hover { opacity: 0.9; }

        /* â”€â”€â”€ Account Diagnosis â”€â”€â”€ */
        .diag-item {
            display: flex; align-items: flex-start; gap: 10px;
            padding: 10px 0; border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .diag-item:last-child { border-bottom: none; }
        .diag-icon { font-size: 1.2rem; min-width: 28px; text-align: center; }
        .diag-label { font-weight: 600; color: var(--text-primary); min-width: 100px; }
        .diag-value { color: var(--text-secondary); }
        .diag-hint { color: #f59e0b; font-size: 0.85rem; margin-top: 2px; }
        .diag-ok .diag-icon { color: #22c55e; }
        .diag-warn .diag-icon { color: #f59e0b; }
        .diag-fail .diag-icon { color: #ef4444; }
        .diag-info .diag-icon { color: #60a5fa; }
        .error-group { margin-top: 12px; padding: 12px 16px; background: rgba(239,68,68,0.08); border-radius: 10px; border: 1px solid rgba(239,68,68,0.15); }
        .error-group h4 { margin: 0 0 8px; color: #f87171; font-size: 0.9rem; }
        .error-group-item { display: flex; gap: 8px; padding: 4px 0; font-size: 0.85rem; }
        .error-group-reason { color: var(--text-primary); font-weight: 500; min-width: 180px; }
        .error-group-models { color: var(--text-secondary); }

        /* â”€â”€â”€ Quota Analysis Section â”€â”€â”€ */
        .quota-section {
            margin-top: 32px;
            display: none;
        }

        .quota-section.show {
            display: block;
        }

        .quota-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 12px;
        }

        .quota-header h2 {
            font-size: 1.3rem;
            font-weight: 700;
            background: linear-gradient(135deg, #a142f4, #ea4335, #fbbc04);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .quota-header p {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .btn-quota {
            padding: 10px 22px;
            background: linear-gradient(135deg, #a142f4, #7b1fa2);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s, transform 0.1s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn-quota:hover:not(:disabled) {
            opacity: 0.9;
        }

        .btn-quota:active:not(:disabled) {
            transform: scale(0.97);
        }

        .btn-quota:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-quota .spinner {
            width: 14px;
            height: 14px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top-color: #fff;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            display: none;
        }

        .btn-quota.loading .spinner {
            display: inline-block;
        }

        /* Quota Table */
        .quota-table-wrapper {
            overflow-x: auto;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: var(--bg-card);
        }

        .quota-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.88rem;
            min-width: 720px;
        }

        .quota-table thead {
            background: rgba(66, 133, 244, 0.08);
        }

        .quota-table th {
            padding: 14px 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text);
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
            font-size: 0.82rem;
        }

        .quota-table th.num {
            text-align: right;
        }

        .quota-table td {
            padding: 12px 16px;
            border-bottom: 1px solid rgba(46, 49, 64, 0.5);
            color: var(--text);
            white-space: nowrap;
        }

        .quota-table td.num {
            text-align: right;
            font-family: 'Consolas', monospace;
            font-weight: 500;
        }

        .quota-table tbody tr:hover {
            background: rgba(66, 133, 244, 0.04);
        }

        .quota-table .rank-medal {
            font-size: 1.1rem;
            min-width: 28px;
            display: inline-block;
        }

        .quota-table .rank-num {
            color: var(--text-secondary);
            font-size: 0.82rem;
        }

        .quota-table .model-name-cell {
            font-weight: 600;
            max-width: 220px;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .quota-table .daily-bar {
            display: inline-block;
            height: 8px;
            border-radius: 4px;
            margin-right: 8px;
            vertical-align: middle;
            transition: width 0.4s ease;
        }

        .quota-table .top1 { color: #fdd663; }
        .quota-table .top2 { color: #c0c0c0; }
        .quota-table .top3 { color: #cd7f32; }

        .quota-source {
            font-size: 0.72rem;
            padding: 2px 6px;
            border-radius: 10px;
            background: rgba(161, 66, 244, 0.12);
            color: #c58af9;
        }

        .quota-source.api {
            background: rgba(15, 157, 88, 0.12);
            color: #81c995;
        }

        /* Token Calculator */
        .token-calculator {
            margin-top: 24px;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 24px;
        }

        .token-calculator h3 {
            font-size: 1.05rem;
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .calc-input-row {
            display: flex;
            gap: 12px;
            align-items: center;
            flex-wrap: wrap;
        }

        .calc-input-row input {
            flex: 1;
            min-width: 200px;
            padding: 12px 16px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 8px;
            color: var(--text);
            font-size: 0.95rem;
            font-family: 'Consolas', monospace;
            outline: none;
        }

        .calc-input-row input:focus {
            border-color: #a142f4;
        }

        .calc-input-row input::placeholder {
            color: var(--text-secondary);
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        .btn-calc {
            padding: 12px 24px;
            background: linear-gradient(135deg, #a142f4, #7b1fa2);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .btn-calc:hover {
            opacity: 0.9;
        }

        .calc-presets {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .calc-preset {
            padding: 5px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 0.78rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .calc-preset:hover {
            border-color: #a142f4;
            color: #c58af9;
        }

        .calc-results {
            margin-top: 18px;
            display: none;
        }

        .calc-results.show {
            display: block;
        }

        .calc-result-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .calc-result-table th {
            padding: 10px 14px;
            text-align: left;
            font-weight: 600;
            color: var(--text-secondary);
            border-bottom: 1px solid var(--border);
            font-size: 0.78rem;
        }

        .calc-result-table th.num {
            text-align: right;
        }

        .calc-result-table td {
            padding: 10px 14px;
            border-bottom: 1px solid rgba(46, 49, 64, 0.4);
        }

        .calc-result-table td.num {
            text-align: right;
            font-family: 'Consolas', monospace;
        }

        .calc-result-table .time-fast {
            color: #81c995;
            font-weight: 600;
        }

        .calc-result-table .time-medium {
            color: var(--text);
        }

        .calc-result-table .time-slow {
            color: #fdd663;
        }

        .calc-result-table .time-very-slow {
            color: #f28b82;
        }

        .quota-note {
            margin-top: 16px;
            padding: 14px 18px;
            background: rgba(161, 66, 244, 0.06);
            border: 1px solid rgba(161, 66, 244, 0.15);
            border-radius: 8px;
            font-size: 0.8rem;
            color: var(--text-secondary);
            line-height: 1.7;
        }

        .quota-note strong {
            color: var(--text);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>AI API å¯†é’¥å…¨èƒ½æµ‹è¯•å·¥å…·</h1>
            <p>ç²˜è´´ä»»æ„ API å¯†é’¥ï¼Œè‡ªåŠ¨è¯†åˆ«æœåŠ¡å•† Â· æ£€æµ‹å¯ç”¨æ¨¡å‹ Â· åˆ†æé…é¢ååé‡</p>
        </div>

        <!-- Proxy Mode Banner -->
        <div id="proxyBanner" style="display:none; background:linear-gradient(135deg,#1a3a2a,#1a2a3a); border:1px solid #2d6a4f; border-radius:var(--radius); padding:12px 20px; margin-bottom:16px; font-size:0.9rem; color:#a8dadc;">
            <span style="margin-right:6px;">ğŸ“¡</span>
            <strong style="color:#52b788;">ä»£ç†æ¨¡å¼å·²å¯ç”¨</strong>
            <span style="margin-left:8px; color:#9aa0a6;">æ‰€æœ‰ API è¯·æ±‚é€šè¿‡æœåŠ¡ç«¯ä¸­è½¬ï¼Œå·²ç»•è¿‡æµè§ˆå™¨ CORS é™åˆ¶</span>
        </div>
        <div id="directBanner" style="display:none; background:linear-gradient(135deg,#3a2a1a,#2a1a1a); border:1px solid #6a4a2d; border-radius:var(--radius); padding:12px 20px; margin-bottom:16px; font-size:0.9rem; color:#f4a261;">
            <span style="margin-right:6px;">âš ï¸</span>
            <strong>ç›´è¿æ¨¡å¼</strong>
            <span style="margin-left:8px; color:#9aa0a6;">éƒ¨åˆ† API å¯èƒ½å›  CORS é™åˆ¶æ— æ³•è®¿é—®ã€‚å¦‚é‡é—®é¢˜ï¼Œè¯·è¿è¡Œ</span>
            <code style="background:#252830; padding:2px 8px; border-radius:4px; color:#81b29a; font-size:0.85rem;">py gemini_test.py --web</code>
        </div>

        <!-- Input Section -->
        <div class="input-section">
            <div class="input-group">
                <div class="input-wrapper">
                    <input type="password" id="apiKey" placeholder="ç²˜è´´ä»»æ„ API å¯†é’¥ (AIza... / sk-... / gsk_... / xai-...)" autocomplete="off" spellcheck="false">
                    <button class="toggle-visibility" onclick="toggleKeyVisibility()" title="æ˜¾ç¤º/éšè—å¯†é’¥">ğŸ‘</button>
                </div>
                <button class="btn-test" id="btnTest" onclick="startTest()">
                    <span class="spinner"></span>
                    <span class="btn-text">å¼€å§‹æµ‹è¯•</span>
                </button>
            </div>

            <!-- Proxy -->
            <div class="proxy-section">
                <div class="proxy-toggle" onclick="toggleProxy()">
                    <span id="proxyArrow">â–¶</span> è‡ªå®šä¹‰ API åœ°å€ (ä»£ç†/åä»£)
                </div>
                <div class="proxy-inputs" id="proxyInputs">
                    <input type="text" id="baseUrl" placeholder="è‡ªå®šä¹‰ Base URL (ç•™ç©ºè‡ªåŠ¨è¯†åˆ«)ï¼Œä¾‹å¦‚: https://api.xxx.com/v1">
                    <p class="proxy-hint">ç•™ç©º = è‡ªåŠ¨è¯†åˆ«æœåŠ¡å•†åœ°å€ &nbsp;|&nbsp; æ”¯æŒ Gemini / OpenAI / ç¡…åŸºæµåŠ¨ / DeepSeek ç­‰</p>
                </div>
            </div>

            <!-- Options -->
            <div class="options-row">
                <div class="option-item">
                    <div class="checkbox-wrapper">
                        <input type="checkbox" id="testCall" checked>
                    </div>
                    <label for="testCall">é€ä¸€æµ‹è¯•æ¨¡å‹å¯ç”¨æ€§</label>
                </div>
                <div class="option-item">
                    <label>API ç‰ˆæœ¬:</label>
                    <select id="apiVersion">
                        <option value="v1beta" selected>v1beta (æ¨è)</option>
                        <option value="v1">v1 (ç¨³å®šç‰ˆ)</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar" id="statusBar">
            <span class="status-icon" id="statusIcon"></span>
            <span id="statusText"></span>
        </div>

        <!-- Results -->
        <div class="results-section" id="resultsSection">
            <!-- Summary -->
            <div class="summary" id="summary"></div>

            <!-- Toolbar -->
            <div class="toolbar">
                <input type="text" class="search-box" id="searchBox" placeholder="æœç´¢æ¨¡å‹åç§°æˆ– ID..." oninput="filterModels()">
                <button class="filter-btn active" data-filter="all" onclick="setFilter('all', this)">å…¨éƒ¨</button>
                <button class="filter-btn" data-filter="generateContent" onclick="setFilter('generateContent', this)">æ–‡æœ¬ç”Ÿæˆ</button>
                <button class="filter-btn" data-filter="embedContent" onclick="setFilter('embedContent', this)">åµŒå…¥</button>
            </div>

            <!-- Models Grid -->
            <div class="models-grid" id="modelsGrid"></div>

            <!-- Empty State -->
            <div class="empty-state" id="emptyState" style="display: none;">
                <div class="icon">ğŸ”</div>
                <h3>æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„æ¨¡å‹</h3>
                <p>å°è¯•è°ƒæ•´æœç´¢å…³é”®è¯æˆ–ç­›é€‰æ¡ä»¶</p>
            </div>
        </div>

        <!-- Manual Provider Selector (shown when auto-detect fails) -->
        <div class="manual-provider-selector" id="manualProviderSelector" style="display:none">
            <h3>ğŸ”§ æ‰‹åŠ¨é€‰æ‹©æœåŠ¡å•†</h3>
            <p>è‡ªåŠ¨æ¢æµ‹æœªèƒ½åŒ¹é…ï¼Œè¯·é€‰æ‹©ä½ çš„ API æœåŠ¡å•†:</p>
            <div class="provider-grid" id="providerGrid"></div>
            <div class="custom-url-row">
                <input type="text" id="manualUrlInput" placeholder="æˆ–è¾“å…¥è‡ªå®šä¹‰ API åœ°å€ (å¦‚ https://api.xxx.com/v1)">
                <button class="btn-primary" onclick="useManualUrl()">ä½¿ç”¨æ­¤åœ°å€</button>
            </div>
        </div>

        <!-- Account Diagnosis Section -->
        <div class="quota-section" id="accountSection" style="display:none">
            <div class="quota-header">
                <div>
                    <h2>ğŸ’³ è´¦æˆ·çŠ¶æ€è¯Šæ–­</h2>
                    <p id="accountDesc">æŸ¥è¯¢è´¦æˆ·ä½™é¢ä¸å¯†é’¥çŠ¶æ€</p>
                </div>
            </div>
            <div id="accountContent" style="padding:0 24px 24px"></div>
        </div>

        <!-- Quota Analysis Section -->
        <div class="quota-section" id="quotaSection">
            <div class="quota-header">
                <div>
                    <h2>ğŸ“Š æ¨¡å‹é…é¢ä¸ååé‡åˆ†æ</h2>
                    <p>æ£€æµ‹å„å¯ç”¨æ¨¡å‹çš„é€Ÿç‡é™åˆ¶ï¼Œå¸®åŠ©é€‰æ‹©æœ€é€‚åˆå¤§é‡ Token éœ€æ±‚çš„æ¨¡å‹</p>
                </div>
                <button class="btn-quota" id="btnQuota" onclick="startQuotaAnalysis()">
                    <span class="spinner"></span>
                    <span class="btn-text">å¼€å§‹é…é¢åˆ†æ</span>
                </button>
            </div>

            <!-- Quota Table -->
            <div class="quota-table-wrapper" id="quotaTableWrapper" style="display:none;">
                <table class="quota-table">
                    <thead>
                        <tr>
                            <th style="width:50px;">æ’å</th>
                            <th>æ¨¡å‹åç§°</th>
                            <th class="num">RPM</th>
                            <th class="num">TPM</th>
                            <th class="num">RPD</th>
                            <th class="num">è¾“å‡º/è¯·æ±‚</th>
                            <th class="num">æ¯æ—¥æœ€å¤§åå</th>
                            <th>æ¥æº</th>
                        </tr>
                    </thead>
                    <tbody id="quotaTableBody"></tbody>
                </table>
            </div>

            <!-- Token Calculator -->
            <div class="token-calculator" id="tokenCalculator" style="display:none;">
                <h3>ğŸ§® Token éœ€æ±‚è®¡ç®—å™¨</h3>
                <div class="calc-input-row">
                    <input type="text" id="tokenDemand" placeholder="è¾“å…¥ä½ éœ€è¦å¤„ç†çš„æ€» Token æ•°é‡ (ä¾‹: 10000000 æˆ– 10M)" autocomplete="off">
                    <button class="btn-calc" onclick="calculateTokenDemand()">è®¡ç®—</button>
                </div>
                <div class="calc-presets">
                    <span class="calc-preset" onclick="setTokenPreset(100000)">100K</span>
                    <span class="calc-preset" onclick="setTokenPreset(1000000)">1M</span>
                    <span class="calc-preset" onclick="setTokenPreset(10000000)">10M</span>
                    <span class="calc-preset" onclick="setTokenPreset(100000000)">100M</span>
                    <span class="calc-preset" onclick="setTokenPreset(1000000000)">1B</span>
                </div>
                <div class="calc-results" id="calcResults">
                    <table class="calc-result-table">
                        <thead>
                            <tr>
                                <th>æ¨¡å‹åç§°</th>
                                <th class="num">æ¯æ—¥åå</th>
                                <th class="num">é¢„è®¡è€—æ—¶</th>
                                <th class="num">æ‰€éœ€è¯·æ±‚æ•°</th>
                            </tr>
                        </thead>
                        <tbody id="calcResultBody"></tbody>
                    </table>
                </div>
            </div>

            <div class="quota-note" id="quotaNote" style="display:none;">
                <strong>ğŸ“Œ è¯´æ˜:</strong><br>
                â€¢ <strong>RPM</strong> = æ¯åˆ†é’Ÿè¯·æ±‚æ•°, <strong>TPM</strong> = æ¯åˆ†é’ŸTokenæ•°, <strong>RPD</strong> = æ¯æ—¥è¯·æ±‚æ•°<br>
                â€¢ <strong>æ¯æ—¥æœ€å¤§åå</strong> = min(RPD Ã— å•æ¬¡æœ€å¤§è¾“å‡º, TPM Ã— 1440åˆ†é’Ÿ)<br>
                â€¢ ä¸Šè¡¨æ•°æ®ä¼˜å…ˆå–è‡ª API å“åº”å¤´ (âš¡ æ ‡è¯†)ï¼Œå…¶ä½™ä¸º Google å®˜æ–¹æ–‡æ¡£å…è´¹å±‚å‚è€ƒå€¼<br>
                â€¢ <strong>ä»˜è´¹è´¦æˆ· (Pay-as-you-go)</strong> é™é¢é€šå¸¸é«˜æ•°ç™¾å€ï¼Œä¸”æ— æ¯æ—¥è¯·æ±‚é™åˆ¶
            </div>
        </div>

        <!-- Initial Empty State -->
        <div class="empty-state" id="initialState">
            <div class="icon">ğŸ”‘</div>
            <h3>ç²˜è´´ API å¯†é’¥å¼€å§‹æµ‹è¯•</h3>
            <p>æ”¯æŒ Gemini / OpenAI / ç¡…åŸºæµåŠ¨ / DeepSeek / Moonshot / æ™ºè°± / Groq / xAI ç­‰å¹³å°</p>
        </div>
    </div>

    <script>
        // State
        let allModels = [];
        let currentFilter = 'all';
        let currentApiKey = '';
        let currentBaseUrl = '';
        let currentFormat = 'gemini';  // 'gemini' or 'openai'
        let currentProvider = null;

        // â”€â”€â”€ CORS ä»£ç†æ¨¡å¼ â”€â”€â”€
        // å½“é¡µé¢é€šè¿‡æœåŠ¡å™¨æä¾›æ—¶ (æœ¬åœ° py gemini_test.py --web æˆ– Vercel éƒ¨ç½²)ï¼Œ
        // æ‰€æœ‰ API è¯·æ±‚è‡ªåŠ¨é€šè¿‡ä»£ç†ä¸­è½¬ï¼Œç»•è¿‡æµè§ˆå™¨ CORS é™åˆ¶ã€‚
        // file:// åè®® = ç›´æ¥æ‰“å¼€ HTML æ–‡ä»¶ï¼Œæ— ä»£ç†å¯ç”¨
        const USE_PROXY = window.location.protocol !== 'file:';

        function apiFetch(url, options = {}) {
            if (USE_PROXY) {
                const proxyUrl = `/api/proxy?url=${encodeURIComponent(url)}`;
                return fetch(proxyUrl, options);
            }
            return fetch(url, options);
        }

        // æ˜¾ç¤ºä»£ç†æ¨¡å¼çŠ¶æ€
        document.addEventListener('DOMContentLoaded', () => {
            if (USE_PROXY) {
                document.getElementById('proxyBanner').style.display = 'block';
            } else {
                document.getElementById('directBanner').style.display = 'block';
            }
        });

        // â”€â”€â”€ Provider Auto-Detection â”€â”€â”€
        const PROVIDER_BY_PREFIX = [
            {prefix:'AIza',    name:'Google Gemini',    icon:'ğŸ”µ', base_url:'https://generativelanguage.googleapis.com/v1beta', format:'gemini'},
            {prefix:'sk-ant-', name:'Anthropic Claude', icon:'ğŸŸ¤', base_url:'https://api.anthropic.com/v1',  format:'anthropic'},
            {prefix:'AKID',    name:'è…¾è®¯äº‘',            icon:'ğŸ§', base_url:'',  format:'tencent_secret'},
            {prefix:'gsk_',    name:'Groq',             icon:'ğŸŸ ', base_url:'https://api.groq.com/openai/v1', format:'openai'},
            {prefix:'xai-',    name:'xAI (Grok)',       icon:'âšª', base_url:'https://api.x.ai/v1',           format:'openai'},
        ];
        const PROBE_LIST = [
            {name:'ç¡…åŸºæµåŠ¨',   icon:'ğŸ”·', base_url:'https://api.siliconflow.cn/v1',   format:'openai'},
            {name:'DeepSeek',  icon:'ğŸ”¹', base_url:'https://api.deepseek.com',         format:'openai'},
            {name:'OpenAI',    icon:'ğŸŸ¢', base_url:'https://api.openai.com/v1',        format:'openai'},
            {name:'è…¾è®¯äº‘æ··å…ƒ',  icon:'ğŸ§', base_url:'https://api.hunyuan.cloud.tencent.com/v1', format:'openai'},
            {name:'Moonshot',  icon:'ğŸŒ™', base_url:'https://api.moonshot.cn/v1',       format:'openai'},
            {name:'æ™ºè°± AI',   icon:'ğŸŸ£', base_url:'https://open.bigmodel.cn/api/paas/v4', format:'openai'},
            {name:'é›¶ä¸€ä¸‡ç‰©',   icon:'ğŸŒ', base_url:'https://api.lingyiwanwu.com/v1',   format:'openai'},
            {name:'é˜¿é‡Œäº‘ç™¾ç‚¼', icon:'â˜ï¸',  base_url:'https://dashscope.aliyuncs.com/compatible-mode/v1', format:'openai'},
            {name:'è®¯é£æ˜Ÿç«',   icon:'âœ¨', base_url:'https://spark-api-open.xf-yun.com/v1', format:'openai'},
            {name:'ç«å±±å¼•æ“',   icon:'ğŸŒ‹', base_url:'https://ark.cn-beijing.volces.com/api/v3', format:'openai'},
            {name:'Together',  icon:'ğŸ¤', base_url:'https://api.together.xyz/v1',      format:'openai'},
            {name:'Mistral',   icon:'â“‚ï¸',  base_url:'https://api.mistral.ai/v1',       format:'openai'},
        ];

        async function autoDetectProvider(apiKey) {
            // Custom URL
            const customUrl = document.getElementById('baseUrl').value.trim();
            if (customUrl) {
                const fmt = apiKey.startsWith('AIza') ? 'gemini' : 'openai';
                return {name:'è‡ªå®šä¹‰', icon:'ğŸ”§', base_url:customUrl.replace(/\/+$/, ''), format:fmt};
            }
            // Prefix match
            for (const p of PROVIDER_BY_PREFIX) {
                if (apiKey.startsWith(p.prefix)) return {...p};
            }
            if (apiKey.startsWith('sk-proj-') || apiKey.startsWith('sk-svcacct-')) {
                return {name:'OpenAI', icon:'ğŸŸ¢', base_url:'https://api.openai.com/v1', format:'openai'};
            }
            // Probe for sk- keys
            if (apiKey.startsWith('sk-')) {
                for (const p of PROBE_LIST) {
                    try {
                        const resp = await apiFetch(`${p.base_url}/models`, {
                            headers: {'Authorization': `Bearer ${apiKey}`},
                            signal: AbortSignal.timeout(6000),
                        });
                        if (resp.ok) {
                            const data = await resp.json();
                            if (data.data || data.models || data.object) return {...p};
                        }
                    } catch(e) { /* ignore */ }
                }
            }
            return null;
        }

        // â”€â”€â”€ Manual provider selector â”€â”€â”€
        const MANUAL_PROVIDERS = [
            {name:'è…¾è®¯äº‘æ··å…ƒ',  icon:'ğŸ§', base_url:'https://api.hunyuan.cloud.tencent.com/v1'},
            {name:'ç¡…åŸºæµåŠ¨',   icon:'ğŸ”·', base_url:'https://api.siliconflow.cn/v1'},
            {name:'DeepSeek',  icon:'ğŸ”¹', base_url:'https://api.deepseek.com'},
            {name:'é˜¿é‡Œäº‘ç™¾ç‚¼', icon:'â˜ï¸',  base_url:'https://dashscope.aliyuncs.com/compatible-mode/v1'},
            {name:'æ™ºè°± AI',   icon:'ğŸŸ£', base_url:'https://open.bigmodel.cn/api/paas/v4'},
            {name:'Moonshot',  icon:'ğŸŒ™', base_url:'https://api.moonshot.cn/v1'},
            {name:'è®¯é£æ˜Ÿç«',   icon:'âœ¨', base_url:'https://spark-api-open.xf-yun.com/v1'},
            {name:'ç«å±±å¼•æ“',   icon:'ğŸŒ‹', base_url:'https://ark.cn-beijing.volces.com/api/v3'},
            {name:'OpenAI',    icon:'ğŸŸ¢', base_url:'https://api.openai.com/v1'},
            {name:'Groq',      icon:'ğŸŸ ', base_url:'https://api.groq.com/openai/v1'},
        ];

        function showManualProviderSelector() {
            const selector = document.getElementById('manualProviderSelector');
            const grid = document.getElementById('providerGrid');
            grid.innerHTML = MANUAL_PROVIDERS.map(p =>
                `<button class="provider-btn" onclick="useManualProvider('${p.name}','${p.icon}','${p.base_url}')">
                    <span class="p-icon">${p.icon}</span>
                    <div><div class="p-name">${p.name}</div><div class="p-url">${p.base_url}</div></div>
                </button>`
            ).join('');
            selector.style.display = 'block';
        }

        function hideManualProviderSelector() {
            document.getElementById('manualProviderSelector').style.display = 'none';
        }

        async function useManualProvider(name, icon, baseUrl) {
            hideManualProviderSelector();
            currentProvider = {name, icon, base_url: baseUrl, format: 'openai'};
            currentFormat = 'openai';
            currentBaseUrl = baseUrl;
            // Re-run test with the manually selected provider
            const btn = document.getElementById('btnTest');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.querySelector('.btn-text').textContent = 'æµ‹è¯•ä¸­...';
            showStatus('success', 'âœ…', `å·²é€‰æ‹©: ${icon} ${name}`);

            try {
                showStatus('info', 'â³', `æ­£åœ¨ä» ${name} è·å–æ¨¡å‹åˆ—è¡¨...`);
                allModels = await fetchModels();
                if (allModels.length === 0) {
                    showStatus('error', 'âŒ', `å¯†é’¥åœ¨ ${name} ä¸Šæ— æ³•è·å–æ¨¡å‹ï¼Œè¯·ç¡®è®¤å¯†é’¥å’ŒæœåŠ¡å•†æ˜¯å¦åŒ¹é…`);
                    return;
                }
                showStatus('success', 'âœ…', `å¯†é’¥æœ‰æ•ˆï¼å…±å‘ç° ${allModels.length} ä¸ªæ¨¡å‹`);
                renderSummary();
                renderModels();
                document.getElementById('resultsSection').classList.add('show');
                showQuotaSection();
                const testCall = document.getElementById('testCall').checked;
                if (testCall) await testAllModels();
                if (currentFormat === 'openai') {
                    showStatus('info', 'ğŸ’³', 'æ­£åœ¨æŸ¥è¯¢è´¦æˆ·ä½™é¢...');
                    await showAccountDiagnosis();
                }
                const finalOk = document.querySelectorAll('.btn-test-model.test-success').length;
                const finalFail = document.querySelectorAll('.btn-test-model.test-fail').length;
                const finalTotal = finalOk + finalFail;
                if (finalTotal > 0) {
                    showStatus(finalOk > 0 ? 'success' : 'error', finalOk > 0 ? 'âœ…' : 'âŒ',
                        `æµ‹è¯•å®Œæˆï¼${finalTotal} ä¸ªæ¨¡å‹ä¸­ ${finalOk} ä¸ªå¯ç”¨, ${finalFail} ä¸ªä¸å¯ç”¨ (${icon} ${name})`);
                }
            } catch (err) {
                handleFetchError(err);
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = 'å¼€å§‹æµ‹è¯•';
            }
        }

        function useManualUrl() {
            const url = document.getElementById('manualUrlInput').value.trim();
            if (!url) { alert('è¯·è¾“å…¥ API åœ°å€'); return; }
            useManualProvider('è‡ªå®šä¹‰', 'ğŸ”§', url.replace(/\/+$/, ''));
        }

        // Toggle key visibility
        function toggleKeyVisibility() {
            const input = document.getElementById('apiKey');
            input.type = input.type === 'password' ? 'text' : 'password';
        }

        // Toggle proxy section
        function toggleProxy() {
            const inputs = document.getElementById('proxyInputs');
            const arrow = document.getElementById('proxyArrow');
            inputs.classList.toggle('show');
            arrow.textContent = inputs.classList.contains('show') ? 'â–¼' : 'â–¶';
        }

        // Get base URL (used as fallback if auto-detect set it already)
        function getBaseUrl() {
            if (currentBaseUrl) return currentBaseUrl;
            const customUrl = document.getElementById('baseUrl').value.trim();
            const version = document.getElementById('apiVersion').value;
            if (customUrl) return customUrl.replace(/\/+$/, '');
            return `https://generativelanguage.googleapis.com/${version}`;
        }

        // Show status
        function showStatus(type, icon, text) {
            const bar = document.getElementById('statusBar');
            bar.className = `status-bar show ${type}`;
            document.getElementById('statusIcon').textContent = icon;
            document.getElementById('statusText').textContent = text;
        }

        // Hide status
        function hideStatus() {
            document.getElementById('statusBar').className = 'status-bar';
        }

        // Start test
        async function startTest() {
            const apiKey = document.getElementById('apiKey').value.trim();
            if (!apiKey) {
                showStatus('error', 'âš ï¸', 'è¯·å…ˆè¾“å…¥ API å¯†é’¥');
                return;
            }

            currentApiKey = apiKey;

            const btn = document.getElementById('btnTest');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.querySelector('.btn-text').textContent = 'è¯†åˆ«ä¸­...';

            document.getElementById('initialState').style.display = 'none';
            showStatus('info', 'ğŸ”', 'æ­£åœ¨è‡ªåŠ¨è¯†åˆ« API æœåŠ¡å•†...');

            // Auto-detect provider
            const provider = await autoDetectProvider(apiKey);
            if (provider && provider.format === 'anthropic') {
                document.getElementById('resultsSection').classList.remove('show');
                allModels = [];
                showStatus('error', 'âš ï¸', 'å·²è¯†åˆ«ä¸º Anthropic Claude å¯†é’¥ï¼Œæš‚ä¸æ”¯æŒå…¶åŸç”Ÿ API æ ¼å¼ã€‚è¯·ä½¿ç”¨ OpenAI å…¼å®¹çš„è½¬å‘æœåŠ¡ã€‚');
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = 'å¼€å§‹æµ‹è¯•';
                return;
            }
            if (provider && provider.format === 'tencent_secret') {
                document.getElementById('resultsSection').classList.remove('show');
                allModels = [];
                showStatus('error', 'âš ï¸',
                    'ğŸ§ æ£€æµ‹åˆ°è…¾è®¯äº‘ SecretId (AKID å¼€å¤´)ï¼Œè¿™ä¸æ˜¯ API Keyï¼<br>' +
                    'è¯·å‰å¾€ <a href="https://console.cloud.tencent.com/hunyuan" target="_blank" style="color:#52b788;">è…¾è®¯äº‘æ··å…ƒæ§åˆ¶å°</a> ' +
                    'â†’ã€ŒAPIå¯†é’¥ç®¡ç†ã€â†’ã€Œåˆ›å»ºå¯†é’¥ã€ç”Ÿæˆ sk-* æ ¼å¼çš„ API Key åé‡è¯•ã€‚');
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = 'å¼€å§‹æµ‹è¯•';
                return;
            }
            if (!provider) {
                // æ¸…é™¤ä¸Šä¸€æ¬¡çš„æµ‹è¯•ç»“æœ
                document.getElementById('resultsSection').classList.remove('show');
                document.getElementById('accountSection').style.display = 'none';
                document.getElementById('quotaSection').classList.remove('show');
                allModels = [];

                showStatus('error', 'âŒ', 'è‡ªåŠ¨æ¢æµ‹æœªèƒ½åŒ¹é…åˆ°æœåŠ¡å•†ï¼Œè¯·ä»ä¸‹æ–¹æ‰‹åŠ¨é€‰æ‹©æˆ–å¡«å†™è‡ªå®šä¹‰åœ°å€');
                showManualProviderSelector();
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = 'å¼€å§‹æµ‹è¯•';
                return;
            }
            currentProvider = provider;
            currentFormat = provider.format;
            currentBaseUrl = provider.base_url;
            hideManualProviderSelector();
            showStatus('success', 'âœ…', `å·²è¯†åˆ«: ${provider.icon} ${provider.name} (${provider.format === 'gemini' ? 'Gemini API' : 'OpenAI å…¼å®¹'})`);

            btn.querySelector('.btn-text').textContent = 'æµ‹è¯•ä¸­...';

            try {
                showStatus('info', 'â³', `æ­£åœ¨ä» ${provider.name} è·å–æ¨¡å‹åˆ—è¡¨...`);
                allModels = await fetchModels();

                if (allModels.length === 0) {
                    showStatus('error', 'âŒ', 'API å¯†é’¥æœ‰æ•ˆï¼Œä½†æœªæ‰¾åˆ°ä»»ä½•å¯ç”¨æ¨¡å‹');
                    document.getElementById('resultsSection').classList.remove('show');
                    return;
                }

                showStatus('success', 'âœ…', `å¯†é’¥æœ‰æ•ˆï¼å…±å‘ç° ${allModels.length} ä¸ªæ¨¡å‹`);
                renderSummary();
                renderModels();
                document.getElementById('resultsSection').classList.add('show');
                showQuotaSection();

                // Test each model if checkbox is checked
                const testCall = document.getElementById('testCall').checked;
                if (testCall) {
                    await testAllModels();
                }

                // Account diagnosis for OpenAI-compatible providers
                if (currentFormat === 'openai') {
                    showStatus('info', 'ğŸ’³', 'æ­£åœ¨æŸ¥è¯¢è´¦æˆ·ä½™é¢...');
                    await showAccountDiagnosis();
                }

                // Final status
                const finalOk = document.querySelectorAll('.btn-test-model.test-success').length;
                const finalFail = document.querySelectorAll('.btn-test-model.test-fail').length;
                const finalTotal = finalOk + finalFail;
                if (finalTotal > 0) {
                    showStatus(finalOk > 0 ? 'success' : 'error',
                        finalOk > 0 ? 'âœ…' : 'âŒ',
                        `æµ‹è¯•å®Œæˆï¼${finalTotal} ä¸ªæ¨¡å‹ä¸­ ${finalOk} ä¸ªå¯ç”¨, ${finalFail} ä¸ªä¸å¯ç”¨` +
                        (currentProvider ? ` (${currentProvider.icon} ${currentProvider.name})` : ''));
                }

            } catch (err) {
                handleFetchError(err);
                document.getElementById('resultsSection').classList.remove('show');
            } finally {
                btn.classList.remove('loading');
                btn.disabled = false;
                btn.querySelector('.btn-text').textContent = 'å¼€å§‹æµ‹è¯•';
            }
        }

        // Fetch all models (supports both Gemini and OpenAI formats)
        async function fetchModels() {
            if (currentFormat === 'openai') {
                return await fetchModelsOpenAI();
            }
            return await fetchModelsGemini();
        }

        async function fetchModelsGemini() {
            let models = [];
            let pageToken = '';
            let page = 0;
            do {
                const url = `${currentBaseUrl}/models?key=${currentApiKey}&pageSize=1000` +
                    (pageToken ? `&pageToken=${pageToken}` : '');
                const resp = await apiFetch(url);
                if (!resp.ok) {
                    const body = await resp.json().catch(() => ({}));
                    const err = new Error(body?.error?.message || `HTTP ${resp.status}`);
                    err.status = resp.status;
                    throw err;
                }
                const data = await resp.json();
                if (data.models) models = models.concat(data.models);
                pageToken = data.nextPageToken || '';
                page++;
                if (page > 10) break;
            } while (pageToken);
            models.sort((a, b) => {
                const aName = a.name || '', bName = b.name || '';
                const aG = aName.includes('gemini') ? 1 : 0, bG = bName.includes('gemini') ? 1 : 0;
                if (aG !== bG) return bG - aG;
                return aName.localeCompare(bName);
            });
            return models;
        }

        function guessOpenAIMethods(modelId) {
            const mid = modelId.toLowerCase();
            if (['embed','bge-','e5-','gte-'].some(x => mid.includes(x))) return ['embedContent'];
            if (['tts','whisper','audio','speech'].some(x => mid.includes(x))) return [];
            if (['dall-e','flux','stable-diffusion','cogview'].some(x => mid.includes(x))) return ['predict'];
            if (mid.includes('rerank')) return [];
            return ['generateContent'];
        }

        // â”€â”€â”€ å·²çŸ¥æ¨¡å‹å‚æ•° â”€â”€â”€
        const KNOWN_MODEL_SPECS = {
            'deepseek-chat':{input:65536,output:8192},'deepseek-reasoner':{input:65536,output:8192},
            'deepseek-coder':{input:65536,output:8192},'deepseek-v3':{input:65536,output:8192},
            'deepseek-r1':{input:65536,output:8192},
            'gpt-4o':{input:128000,output:16384},'gpt-4o-mini':{input:128000,output:16384},
            'gpt-4-turbo':{input:128000,output:4096},'gpt-4':{input:8192,output:8192},
            'gpt-3.5-turbo':{input:16385,output:4096},
            'o1':{input:200000,output:100000},'o1-mini':{input:128000,output:65536},
            'o3-mini':{input:200000,output:100000},
            'qwen-turbo':{input:131072,output:8192},'qwen-plus':{input:131072,output:8192},
            'qwen-max':{input:32768,output:8192},'qwen-long':{input:1000000,output:8192},
            'qwen2.5-72b-instruct':{input:131072,output:8192},
            'moonshot-v1-8k':{input:8192,output:4096},'moonshot-v1-32k':{input:32768,output:16384},
            'moonshot-v1-128k':{input:131072,output:65536},
            'glm-4':{input:128000,output:4096},'glm-4-flash':{input:128000,output:4096},
            'glm-4-plus':{input:128000,output:4096},'glm-4-long':{input:1000000,output:4096},
            'yi-large':{input:32768,output:4096},'yi-medium':{input:16384,output:4096},
            'claude-3.5-sonnet':{input:200000,output:8192},'claude-3-haiku':{input:200000,output:4096},
            'mistral-large-latest':{input:128000,output:4096},
            'hunyuan-pro':{input:32000,output:4096},'hunyuan-standard':{input:32000,output:4096},
            'hunyuan-lite':{input:32000,output:4096},'hunyuan-turbo':{input:32000,output:4096},
            'hunyuan-large':{input:32000,output:4096},'hunyuan-code':{input:32000,output:4096},
            'hunyuan-vision':{input:32000,output:4096},
            'generalv3.5':{input:128000,output:4096},'4.0Ultra':{input:128000,output:8192},
        };

        function fillModelSpecs(model) {
            if (model.inputTokenLimit && model.outputTokenLimit) return;
            const mid = (model._model_id || model.name?.replace('models/','') || '').toLowerCase();
            let specs = KNOWN_MODEL_SPECS[mid];
            if (!specs) {
                for (const [key, val] of Object.entries(KNOWN_MODEL_SPECS)) {
                    if (mid.startsWith(key) || key.startsWith(mid)) { specs = val; break; }
                }
            }
            if (specs) {
                if (!model.inputTokenLimit)  model.inputTokenLimit  = specs.input;
                if (!model.outputTokenLimit) model.outputTokenLimit = specs.output;
            }
        }

        // â”€â”€â”€ é”™è¯¯ç¿»è¯‘ â”€â”€â”€
        const ERROR_KEYWORD_MAP = [
            ['insufficient balance', 'è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè¯·å‰å¾€å¹³å°å……å€¼'],
            ['insufficient_balance', 'è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè¯·å‰å¾€å¹³å°å……å€¼'],
            ['insufficient quota',   'é…é¢ä¸è¶³ï¼Œè¯·å‰å¾€å¹³å°å……å€¼'],
            ['quota exceeded',       'é…é¢å·²è€—å°½'],
            ['rate limit',           'è¯·æ±‚é¢‘ç‡è¶…é™'],
            ['rate_limit_exceeded',  'è¯·æ±‚é¢‘ç‡è¶…é™'],
            ['invalid api key',      'å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®å¤åˆ¶'],
            ['invalid_api_key',      'å¯†é’¥æ— æ•ˆï¼Œè¯·æ£€æŸ¥æ˜¯å¦æ­£ç¡®å¤åˆ¶'],
            ['authentication',       'è®¤è¯å¤±è´¥ï¼Œå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ'],
            ['unauthorized',         'æœªæˆæƒï¼Œå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ'],
            ['permission denied',    'æ²¡æœ‰æƒé™ï¼Œå¯èƒ½æœªå¼€é€šæ­¤æ¨¡å‹'],
            ['model not found',      'æ¨¡å‹ä¸å­˜åœ¨æˆ–æœªå¼€é€š'],
            ['model_not_found',      'æ¨¡å‹ä¸å­˜åœ¨æˆ–æœªå¼€é€š'],
            ['content filter',       'å†…å®¹è¢«å®‰å…¨è¿‡æ»¤å™¨æ‹¦æˆª'],
            ['context length exceeded','è¾“å…¥è¶…å‡ºä¸Šä¸‹æ–‡é•¿åº¦é™åˆ¶'],
            ['overloaded',           'æœåŠ¡è¿‡è½½ï¼Œè¯·ç¨åé‡è¯•'],
            ['billing',              'è®¡è´¹é—®é¢˜ï¼Œè¯·æ£€æŸ¥è´¦æˆ·çŠ¶æ€'],
            ['payment required',     'éœ€è¦ä»˜è´¹ï¼Œè¯·å…ˆå……å€¼'],
            ['expired',              'å¯†é’¥å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç”Ÿæˆ'],
            ['deactivated',          'è´¦æˆ·å·²åœç”¨'],
        ];
        const ERROR_STATUS_MAP = {
            400:'è¯·æ±‚å‚æ•°é”™è¯¯', 401:'å¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ', 402:'è´¦æˆ·ä½™é¢ä¸è¶³ï¼Œè¯·å……å€¼',
            403:'æ²¡æœ‰æƒé™è®¿é—®æ­¤æ¨¡å‹', 404:'æ¨¡å‹ä¸å­˜åœ¨æˆ–å·²ä¸‹çº¿', 429:'è¯·æ±‚å¤ªé¢‘ç¹ï¼Œå·²è§¦å‘é€Ÿç‡é™åˆ¶',
            500:'æœåŠ¡å•†å†…éƒ¨é”™è¯¯', 502:'æœåŠ¡å•†ç½‘å…³é”™è¯¯', 503:'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨',
            504:'æœåŠ¡å•†ç½‘å…³è¶…æ—¶', 529:'æœåŠ¡è¿‡è½½ï¼Œè¯·ç¨åé‡è¯•',
        };

        function translateError(status, msg) {
            const lower = (msg || '').toLowerCase();
            for (const [kw, cn] of ERROR_KEYWORD_MAP) {
                if (lower.includes(kw)) return cn;
            }
            if (ERROR_STATUS_MAP[status]) return ERROR_STATUS_MAP[status];
            return ERROR_STATUS_MAP[status] || `HTTP ${status}: ${(msg||'').substring(0,60)}`;
        }

        async function fetchModelsOpenAI() {
            const resp = await apiFetch(`${currentBaseUrl}/models`, {
                headers: {'Authorization': `Bearer ${currentApiKey}`}
            });
            if (!resp.ok) {
                const body = await resp.json().catch(() => ({}));
                const err = new Error(body?.error?.message || `HTTP ${resp.status}`);
                err.status = resp.status;
                throw err;
            }
            const data = await resp.json();
            const rawModels = data.data || data.models || [];
            return rawModels.map(m => {
                const id = m.id || '';
                const methods = guessOpenAIMethods(id);
                const model = {
                    name: `models/${id}`,
                    displayName: id,
                    description: m.description || `Provider: ${currentProvider?.name || 'Unknown'}`,
                    supportedGenerationMethods: methods,
                    inputTokenLimit: m.context_length || m.max_context_length || m.context_window || m.max_input_tokens || null,
                    outputTokenLimit: m.max_output_tokens || m.max_completion_tokens || m.max_tokens || null,
                    _format: 'openai',
                    _model_id: id,
                    _owned_by: m.owned_by || '',
                };
                fillModelSpecs(model);
                return model;
            }).sort((a, b) => (a._model_id || '').localeCompare(b._model_id || ''));
        }

        // Query account balance for OpenAI-compatible providers
        async function queryBalance() {
            if (currentFormat !== 'openai' || !currentApiKey) return null;
            const baseNoVersion = currentBaseUrl.replace(/\/v[0-9]+\/?$/, '').replace(/\/+$/, '');
            const endpoints = [
                { path: '/user/info',    type: 'siliconflow' },
                { path: '/user/balance', type: 'deepseek'    },
                { path: '/dashboard/billing/credit_grants', type: 'openai_credit' },
            ];
            for (const ep of endpoints) {
                try {
                    const resp = await apiFetch(`${baseNoVersion}${ep.path}`, {
                        headers: { 'Authorization': `Bearer ${currentApiKey}` },
                        signal: AbortSignal.timeout(6000),
                    });
                    if (!resp.ok) continue;
                    const data = await resp.json();
                    if (ep.type === 'siliconflow') {
                        const bal = data?.data?.balance;
                        if (bal != null) return { balance: parseFloat(bal), currency: 'CNY', source: 'SiliconFlow' };
                    } else if (ep.type === 'deepseek') {
                        const infos = data?.balance_infos;
                        if (infos?.length) return { balance: parseFloat(infos[0].total_balance || 0), currency: infos[0].currency || 'CNY', source: 'DeepSeek' };
                        if (data?.is_available != null) return { available: data.is_available, source: 'DeepSeek' };
                    } else if (ep.type === 'openai_credit') {
                        const total = data?.total_granted || 0, used = data?.total_used || 0;
                        return { balance: total - used, currency: 'USD', source: 'OpenAI' };
                    }
                } catch(e) { /* ignore */ }
            }
            return null;
        }

        // Handle fetch errors (with Chinese translation)
        function handleFetchError(err) {
            if (err.message?.includes('Failed to fetch') || err.message?.includes('NetworkError') || err.message?.includes('TypeError')) {
                if (USE_PROXY) {
                    showStatus('error', 'âŒ', 'ç½‘ç»œè¿æ¥å¤±è´¥ï¼Œæœ¬åœ°ä»£ç†æœåŠ¡å™¨æ— æ³•è®¿é—®ç›®æ ‡ APIï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
                } else {
                    showStatus('error', 'âŒ', 'ç½‘ç»œè¿æ¥å¤±è´¥ (å¯èƒ½å›  CORS é™åˆ¶)ã€‚å»ºè®®è¿è¡Œ py gemini_test.py --web å¯ç”¨ä»£ç†æ¨¡å¼');
                }
            } else if (err.status) {
                const cnMsg = translateError(err.status, err.message || '');
                showStatus('error', 'âŒ', cnMsg);
            } else {
                showStatus('error', 'âŒ', `æµ‹è¯•å¤±è´¥: ${err.message}`);
            }
        }

        // Render summary cards
        function renderSummary() {
            const total = allModels.length;
            let generateCount = 0;
            let embedCount = 0;
            let otherCount = 0;

            allModels.forEach(m => {
                const methods = m.supportedGenerationMethods || [];
                if (methods.includes('generateContent')) generateCount++;
                if (methods.includes('embedContent') || methods.includes('embedText')) embedCount++;
                if (!methods.includes('generateContent') && !methods.includes('embedContent') && !methods.includes('embedText')) otherCount++;
            });

            const providerHtml = currentProvider
                ? `<div class="summary-card" style="background:linear-gradient(135deg,rgba(99,102,241,.2),rgba(59,130,246,.1));border-color:rgba(99,102,241,.3)">
                       <div class="number" style="font-size:1.4rem">${currentProvider.icon} ${currentProvider.name}</div>
                       <div class="label">${currentFormat === 'gemini' ? 'Gemini API' : 'OpenAI å…¼å®¹'}</div>
                   </div>` : '';

            document.getElementById('summary').innerHTML = `
                ${providerHtml}
                <div class="summary-card total">
                    <div class="number">${total}</div>
                    <div class="label">æ¨¡å‹æ€»æ•°</div>
                </div>
                <div class="summary-card generate">
                    <div class="number">${generateCount}</div>
                    <div class="label">æ”¯æŒæ–‡æœ¬ç”Ÿæˆ</div>
                </div>
                <div class="summary-card embed">
                    <div class="number">${embedCount}</div>
                    <div class="label">æ”¯æŒåµŒå…¥</div>
                </div>
                <div class="summary-card other">
                    <div class="number">${otherCount}</div>
                    <div class="label">å…¶ä»–ç±»å‹</div>
                </div>
            `;
        }

        // Render model cards
        function renderModels() {
            const search = document.getElementById('searchBox').value.toLowerCase();
            const grid = document.getElementById('modelsGrid');
            const emptyState = document.getElementById('emptyState');

            let filtered = allModels;

            // Filter by method
            if (currentFilter === 'generateContent') {
                filtered = filtered.filter(m =>
                    (m.supportedGenerationMethods || []).includes('generateContent'));
            } else if (currentFilter === 'embedContent') {
                filtered = filtered.filter(m => {
                    const methods = m.supportedGenerationMethods || [];
                    return methods.includes('embedContent') || methods.includes('embedText');
                });
            }

            // Filter by search
            if (search) {
                filtered = filtered.filter(m =>
                    (m.displayName || '').toLowerCase().includes(search) ||
                    (m.name || '').toLowerCase().includes(search) ||
                    (m.description || '').toLowerCase().includes(search)
                );
            }

            if (filtered.length === 0) {
                grid.innerHTML = '';
                emptyState.style.display = 'block';
                return;
            }

            emptyState.style.display = 'none';

            grid.innerHTML = filtered.map((m, idx) => {
                const name = m.displayName || m.name?.replace('models/', '') || 'Unknown';
                const id = m.name || '';
                const desc = m.description || 'æš‚æ— æè¿°';
                const methods = m.supportedGenerationMethods || [];

                const tags = methods.map(method => {
                    const tagMap = {
                        'generateContent': { cls: 'generate', label: 'æ–‡æœ¬ç”Ÿæˆ' },
                        'embedContent': { cls: 'embed', label: 'åµŒå…¥' },
                        'embedText': { cls: 'embed', label: 'æ–‡æœ¬åµŒå…¥' },
                        'countTokens': { cls: 'count', label: 'Token è®¡æ•°' },
                        'createTunedModel': { cls: 'tune', label: 'å¾®è°ƒ' },
                        'createCachedContent': { cls: 'count', label: 'ç¼“å­˜' },
                        'batchEmbedContents': { cls: 'embed', label: 'æ‰¹é‡åµŒå…¥' },
                        'batchEmbedText': { cls: 'embed', label: 'æ‰¹é‡æ–‡æœ¬åµŒå…¥' },
                    };
                    const info = tagMap[method] || { cls: 'other-method', label: method };
                    return `<span class="tag ${info.cls}">${info.label}</span>`;
                }).join('');

                const inputLimit = m.inputTokenLimit ? formatNumber(m.inputTokenLimit) : '-';
                const outputLimit = m.outputTokenLimit ? formatNumber(m.outputTokenLimit) : '-';
                const temp = m.temperature != null ? m.temperature : '-';
                const topP = m.topP != null ? m.topP : '-';

                const canGenerate = methods.includes('generateContent');
                const canEmbed = methods.includes('embedContent') || methods.includes('embedText');

                let testBtnHtml = '';
                if (canGenerate || canEmbed) {
                    testBtnHtml = `<button class="btn-test-model" data-model="${id}" data-type="${canGenerate ? 'generate' : 'embed'}" onclick="testSingleModel(this)">
                        æµ‹è¯•æ­¤æ¨¡å‹
                    </button>`;
                }

                // å¯¹è¯è¾“å…¥åŒº (ä»…é™æ”¯æŒ generateContent çš„æ¨¡å‹)
                let chatHtml = '';
                if (canGenerate) {
                    const safeId = id.replace(/[^a-zA-Z0-9-]/g, '_');
                    chatHtml = `
                        <div class="chat-area">
                            <div class="chat-input-row">
                                <textarea class="chat-input" id="input_${safeId}" placeholder="è¾“å…¥å†…å®¹ä¸æ¨¡å‹å¯¹è¯..." rows="1" onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendPrompt('${id}','${safeId}')}"></textarea>
                                <button class="btn-send" id="sendbtn_${safeId}" onclick="sendPrompt('${id}','${safeId}')">å‘é€</button>
                            </div>
                            <div class="chat-response" id="resp_${safeId}"></div>
                        </div>
                    `;
                }

                return `
                    <div class="model-card" style="animation-delay: ${idx * 0.03}s">
                        <div class="model-name">${escapeHtml(name)}</div>
                        <div class="model-id">${escapeHtml(id)}</div>
                        <div class="model-desc">${escapeHtml(desc)}</div>
                        <div class="tags">${tags}</div>
                        <div class="model-meta">
                            <div class="meta-item">
                                <span class="meta-label">è¾“å…¥ä¸Šé™</span>
                                <span class="meta-value">${inputLimit} tokens</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">è¾“å‡ºä¸Šé™</span>
                                <span class="meta-value">${outputLimit} tokens</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">æ¸©åº¦</span>
                                <span class="meta-value">${temp}</span>
                            </div>
                            <div class="meta-item">
                                <span class="meta-label">Top P</span>
                                <span class="meta-value">${topP}</span>
                            </div>
                        </div>
                        ${testBtnHtml}
                        ${chatHtml}
                    </div>
                `;
            }).join('');
        }

        // Test a single model (supports both Gemini and OpenAI formats)
        async function testSingleModel(btn) {
            const model = btn.dataset.model;
            const type = btn.dataset.type;

            btn.className = 'btn-test-model testing';
            btn.textContent = 'æµ‹è¯•ä¸­...';

            try {
                if (currentFormat === 'openai') {
                    await testSingleModelOpenAI(btn, model, type);
                } else {
                    await testSingleModelGemini(btn, model, type);
                }
            } catch (err) {
                btn.className = 'btn-test-model test-fail';
                btn.textContent = `ç½‘ç»œé”™è¯¯: ${(err.message || '').substring(0, 40)}`;
            }
        }

        async function testSingleModelGemini(btn, model, type) {
            if (type === 'generate') {
                const url = `${currentBaseUrl}/${model}:generateContent?key=${currentApiKey}`;
                const resp = await apiFetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: 'Hello, respond with just "OK".' }] }],
                        generationConfig: { maxOutputTokens: 10 }
                    })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    const text = data?.candidates?.[0]?.content?.parts?.[0]?.text || '(ç©ºå“åº”)';
                    btn.className = 'btn-test-model test-success';
                    btn.textContent = `å¯ç”¨ - å“åº”: "${text.substring(0, 30)}"`;
                } else {
                    const errData = await resp.json().catch(() => ({}));
                    btn.className = 'btn-test-model test-fail';
                    btn.textContent = `ä¸å¯ç”¨ (${resp.status}): ${errData?.error?.message?.substring(0, 50) || 'æœªçŸ¥é”™è¯¯'}`;
                }
            } else {
                const isEmbedText = !allModels.find(m => m.name === model)?.supportedGenerationMethods?.includes('embedContent');
                const url = isEmbedText
                    ? `${currentBaseUrl}/${model}:embedText?key=${currentApiKey}`
                    : `${currentBaseUrl}/${model}:embedContent?key=${currentApiKey}`;
                const body = isEmbedText
                    ? JSON.stringify({ text: 'Hello' })
                    : JSON.stringify({ content: { parts: [{ text: 'Hello' }] } });
                const resp = await apiFetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body });
                if (resp.ok) {
                    const data = await resp.json();
                    const dim = data?.embedding?.values?.length || data?.embedding?.value?.length || '?';
                    btn.className = 'btn-test-model test-success';
                    btn.textContent = `å¯ç”¨ - ç»´åº¦: ${dim}`;
                } else {
                    const errData = await resp.json().catch(() => ({}));
                    btn.className = 'btn-test-model test-fail';
                    btn.textContent = `ä¸å¯ç”¨ (${resp.status}): ${errData?.error?.message?.substring(0, 50) || 'æœªçŸ¥é”™è¯¯'}`;
                }
            }
        }

        async function testSingleModelOpenAI(btn, model, type) {
            const modelId = model.replace('models/', '');
            if (type === 'generate') {
                const resp = await apiFetch(`${currentBaseUrl}/chat/completions`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentApiKey}` },
                    body: JSON.stringify({
                        model: modelId,
                        messages: [{ role: 'user', content: 'Say OK' }],
                        max_tokens: 10,
                    })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    const text = data?.choices?.[0]?.message?.content || '(ç©ºå“åº”)';
                    btn.className = 'btn-test-model test-success';
                    btn.textContent = `âœ“ å¯ç”¨ - "${text.substring(0, 30).trim()}"`;
                } else {
                    const errData = await resp.json().catch(() => ({}));
                    const rawMsg = errData?.error?.message || (typeof errData?.error === 'string' ? errData.error : '') || '';
                    const cnMsg = translateError(resp.status, rawMsg);
                    btn.className = 'btn-test-model test-fail';
                    btn.textContent = `âœ— ${cnMsg.substring(0, 50)}`;
                }
            } else {
                const resp = await apiFetch(`${currentBaseUrl}/embeddings`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentApiKey}` },
                    body: JSON.stringify({ model: modelId, input: 'Hello' })
                });
                if (resp.ok) {
                    const data = await resp.json();
                    const dim = data?.data?.[0]?.embedding?.length || '?';
                    btn.className = 'btn-test-model test-success';
                    btn.textContent = `âœ“ å¯ç”¨ - ç»´åº¦: ${dim}`;
                } else {
                    const errData = await resp.json().catch(() => ({}));
                    const rawMsg = errData?.error?.message || (typeof errData?.error === 'string' ? errData.error : '') || '';
                    const cnMsg = translateError(resp.status, rawMsg);
                    btn.className = 'btn-test-model test-fail';
                    btn.textContent = `âœ— ${cnMsg.substring(0, 50)}`;
                }
            }
        }

        // Send a custom prompt to a model
        async function sendPrompt(modelId, safeId) {
            const input = document.getElementById(`input_${safeId}`);
            const respDiv = document.getElementById(`resp_${safeId}`);
            const sendBtn = document.getElementById(`sendbtn_${safeId}`);
            const prompt = input.value.trim();

            if (!prompt) return;
            if (!currentApiKey) {
                respDiv.className = 'chat-response show error';
                respDiv.innerHTML = 'è¯·å…ˆåœ¨é¡¶éƒ¨è¾“å…¥ API å¯†é’¥å¹¶ç‚¹å‡»"å¼€å§‹æµ‹è¯•"';
                return;
            }

            // Show loading
            sendBtn.disabled = true;
            sendBtn.textContent = 'è¯·æ±‚ä¸­...';
            respDiv.className = 'chat-response show loading';
            respDiv.innerHTML = '<span class="response-label">æ¨¡å‹å“åº”ä¸­...</span>â³ æ­£åœ¨ç­‰å¾…å›å¤...';

            const t0 = performance.now();

            try {
                let resp, data, text, metaHtml;
                const elapsed = () => ((performance.now() - t0) / 1000).toFixed(1);

                if (currentFormat === 'openai') {
                    resp = await apiFetch(`${currentBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentApiKey}` },
                        body: JSON.stringify({ model: modelId.replace('models/', ''), messages: [{ role: 'user', content: prompt }] })
                    });
                } else {
                    resp = await apiFetch(`${currentBaseUrl}/${modelId}:generateContent?key=${currentApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                }

                if (resp.ok) {
                    data = await resp.json();
                    if (currentFormat === 'openai') {
                        text = data?.choices?.[0]?.message?.content || '(ç©ºå“åº”)';
                        metaHtml = `è€—æ—¶ ${elapsed()}s`;
                        const usage = data?.usage;
                        if (usage) metaHtml += ` Â· è¾“å…¥ ${usage.prompt_tokens || '?'} tokens Â· è¾“å‡º ${usage.completion_tokens || '?'} tokens`;
                    } else {
                        const candidate = data?.candidates?.[0];
                        text = candidate?.content?.parts?.map(p => p.text || '').join('') || '(ç©ºå“åº”)';
                        const finishReason = candidate?.finishReason || '';
                        const tokenInfo = data?.usageMetadata;
                        metaHtml = `è€—æ—¶ ${elapsed()}s`;
                        if (tokenInfo) metaHtml += ` Â· è¾“å…¥ ${tokenInfo.promptTokenCount || '?'} tokens Â· è¾“å‡º ${tokenInfo.candidatesTokenCount || tokenInfo.totalTokenCount || '?'} tokens`;
                        if (finishReason && finishReason !== 'STOP') metaHtml += ` Â· åœæ­¢åŸå› : ${finishReason}`;
                    }
                    respDiv.className = 'chat-response show';
                    respDiv.innerHTML = `<span class="response-label">æ¨¡å‹å“åº”:</span><span class="response-text">${escapeHtml(text)}</span><span class="response-meta">${metaHtml}</span>`;
                } else {
                    const errData = await resp.json().catch(() => ({}));
                    const rawMsg = errData?.error?.message || (typeof errData?.error === 'string' ? errData.error : '') || '';
                    const cnMsg = (currentFormat === 'openai') ? translateError(resp.status, rawMsg) : (rawMsg || `HTTP ${resp.status}`);
                    respDiv.className = 'chat-response show error';
                    respDiv.innerHTML = `<span class="response-label">è¯·æ±‚å¤±è´¥:</span><span class="response-text">${escapeHtml(cnMsg)}</span><span class="response-meta">è€—æ—¶ ${elapsed()}s</span>`;
                }
            } catch (err) {
                respDiv.className = 'chat-response show error';
                respDiv.innerHTML = `<span class="response-label">ç½‘ç»œé”™è¯¯:</span><span class="response-text">${escapeHtml(err.message || 'è¿æ¥å¤±è´¥')}</span>`;
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
            }
        }

        // Test all models automatically
        async function testAllModels() {
            const buttons = document.querySelectorAll('.btn-test-model');
            // Test in batches of 5 to avoid rate limiting
            const batchSize = 5;

            for (let i = 0; i < buttons.length; i += batchSize) {
                const batch = Array.from(buttons).slice(i, i + batchSize);
                await Promise.all(batch.map(btn => testSingleModel(btn)));

                // Small delay between batches
                if (i + batchSize < buttons.length) {
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            // Update status with results
            const successCount = document.querySelectorAll('.btn-test-model.test-success').length;
            const failCount = document.querySelectorAll('.btn-test-model.test-fail').length;
            const totalTested = successCount + failCount;

            showStatus('success', 'âœ…',
                `æµ‹è¯•å®Œæˆï¼${allModels.length} ä¸ªæ¨¡å‹ä¸­ï¼Œ${totalTested} ä¸ªå·²æµ‹è¯•: ${successCount} ä¸ªå¯ç”¨, ${failCount} ä¸ªä¸å¯ç”¨`);
        }

        // Filter models
        function setFilter(filter, btn) {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderModels();
        }

        function filterModels() {
            renderModels();
        }

        // Helpers
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(0) + 'K';
            return num.toString();
        }

        function escapeHtml(str) {
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        // Enter key support
        document.getElementById('apiKey').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') startTest();
        });

        document.getElementById('tokenDemand').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') calculateTokenDemand();
        });

        // â•â•â• Quota Analysis â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        // Known free-tier rate limits (fallback reference)
        const KNOWN_FREE_LIMITS = {
            "models/gemini-2.5-pro":               {rpm: 5,   tpm: 250000,   rpd: 25},
            "models/gemini-2.5-flash":             {rpm: 10,  tpm: 250000,   rpd: 500},
            "models/gemini-2.5-flash-lite":        {rpm: 30,  tpm: 1000000,  rpd: 3000},
            "models/gemini-2.5-flash-preview-09-2025":      {rpm: 10, tpm: 250000, rpd: 500},
            "models/gemini-2.5-flash-lite-preview-09-2025": {rpm: 30, tpm: 1000000, rpd: 3000},
            "models/gemini-2.5-flash-image":       {rpm: 10,  tpm: 250000,   rpd: 500},
            "models/gemini-2.0-flash":             {rpm: 15,  tpm: 1000000,  rpd: 1500},
            "models/gemini-2.0-flash-001":         {rpm: 15,  tpm: 1000000,  rpd: 1500},
            "models/gemini-2.0-flash-exp-image-generation": {rpm: 10, tpm: 1000000, rpd: 1500},
            "models/gemini-2.0-flash-lite":        {rpm: 30,  tpm: 1000000,  rpd: 3000},
            "models/gemini-2.0-flash-lite-001":    {rpm: 30,  tpm: 1000000,  rpd: 3000},
            "models/gemini-exp-1206":              {rpm: 10,  tpm: 1000000,  rpd: 50},
            "models/gemini-3-pro-preview":         {rpm: 5,   tpm: 250000,   rpd: 25},
            "models/gemini-3-flash-preview":       {rpm: 10,  tpm: 250000,   rpd: 500},
            "models/gemini-3-pro-image-preview":   {rpm: 5,   tpm: 250000,   rpd: 25},
            "models/nano-banana-pro-preview":      {rpm: 5,   tpm: 250000,   rpd: 25},
            "models/gemini-flash-latest":          {rpm: 10,  tpm: 250000,   rpd: 500},
            "models/gemini-flash-lite-latest":     {rpm: 30,  tpm: 1000000,  rpd: 3000},
            "models/gemini-pro-latest":            {rpm: 5,   tpm: 250000,   rpd: 25},
            "models/gemma-3-1b-it":               {rpm: 30,  tpm: 1000000,  rpd: 14400},
            "models/gemma-3-4b-it":               {rpm: 30,  tpm: 1000000,  rpd: 14400},
            "models/gemma-3-12b-it":              {rpm: 30,  tpm: 1000000,  rpd: 14400},
            "models/gemma-3-27b-it":              {rpm: 30,  tpm: 1000000,  rpd: 14400},
            "models/gemma-3n-e4b-it":             {rpm: 30,  tpm: 1000000,  rpd: 14400},
            "models/gemma-3n-e2b-it":             {rpm: 30,  tpm: 1000000,  rpd: 14400},
            "models/gemini-robotics-er-1.5-preview": {rpm: 5, tpm: 250000, rpd: 25},
        };

        let quotaData = [];

        // Parse rate-limit headers from fetch response
        function parseRateLimitHeaders(headers) {
            const info = {};
            const headerMap = [
                ['x-ratelimit-limit-requests', 'rpm'],
                ['x-ratelimit-remaining-requests', 'rpm_remaining'],
                ['x-ratelimit-limit-tokens', 'tpm'],
                ['x-ratelimit-remaining-tokens', 'tpm_remaining'],
                ['x-ratelimit-limit-requests-per-day', 'rpd'],
                ['x-ratelimit-remaining-requests-per-day', 'rpd_remaining'],
            ];
            for (const [header, field] of headerMap) {
                const val = headers.get(header);
                if (val !== null) {
                    const num = parseInt(val, 10);
                    if (!isNaN(num)) info[field] = num;
                }
            }
            return info;
        }

        // Find known limits by exact or prefix match
        function getKnownLimits(modelName) {
            if (KNOWN_FREE_LIMITS[modelName]) {
                return { ...KNOWN_FREE_LIMITS[modelName], source: 'å‚è€ƒå€¼' };
            }
            for (const [knownName, limits] of Object.entries(KNOWN_FREE_LIMITS)) {
                if (modelName.startsWith(knownName) || knownName.startsWith(modelName)) {
                    return { ...limits, source: 'å‚è€ƒå€¼ (è¿‘ä¼¼)' };
                }
            }
            return null;
        }

        // Start quota analysis
        async function startQuotaAnalysis() {
            if (!currentApiKey) {
                showStatus('error', 'âš ï¸', 'è¯·å…ˆè¾“å…¥ API å¯†é’¥å¹¶æµ‹è¯•');
                return;
            }

            // Filter: only available generateContent models
            const genModels = allModels.filter(m => {
                const methods = m.supportedGenerationMethods || [];
                if (!methods.includes('generateContent')) return false;
                // Check if model was tested and passed
                const btn = document.querySelector(`.btn-test-model[data-model="${m.name}"]`);
                if (btn && btn.classList.contains('test-fail')) return false;
                return true;
            });

            if (genModels.length === 0) {
                showStatus('error', 'âš ï¸', 'æ²¡æœ‰å¯ç”¨çš„æ–‡æœ¬ç”Ÿæˆæ¨¡å‹ï¼Œæ— æ³•è¿›è¡Œé…é¢åˆ†æ');
                return;
            }

            const btn = document.getElementById('btnQuota');
            btn.classList.add('loading');
            btn.disabled = true;
            btn.querySelector('.btn-text').textContent = 'åˆ†æä¸­...';

            showStatus('info', 'â³', `æ­£åœ¨æ£€æµ‹ ${genModels.length} ä¸ªæ¨¡å‹çš„é…é¢é™åˆ¶...`);

            quotaData = [];

            // Fetch rate limits for each model in batches
            const batchSize = 3;
            for (let i = 0; i < genModels.length; i += batchSize) {
                const batch = genModels.slice(i, i + batchSize);
                const results = await Promise.all(batch.map(m => fetchModelQuota(m)));
                quotaData.push(...results);

                showStatus('info', 'â³',
                    `æ­£åœ¨æ£€æµ‹é…é¢... ${Math.min(i + batchSize, genModels.length)}/${genModels.length}`);

                if (i + batchSize < genModels.length) {
                    await new Promise(r => setTimeout(r, 300));
                }
            }

            // Sort by daily max output descending
            quotaData.sort((a, b) => (b.dailyMaxOutput || 0) - (a.dailyMaxOutput || 0));

            renderQuotaTable();
            showStatus('success', 'âœ…',
                `é…é¢åˆ†æå®Œæˆï¼å·²æ£€æµ‹ ${quotaData.length} ä¸ªæ¨¡å‹çš„é™é¢`);

            btn.classList.remove('loading');
            btn.disabled = false;
            btn.querySelector('.btn-text').textContent = 'é‡æ–°åˆ†æ';
        }

        // Fetch quota for a single model
        async function fetchModelQuota(model) {
            const name = model.name || '';
            const displayName = model.displayName || name.replace('models/', '');
            const inputLimit = model.inputTokenLimit || 0;
            const outputLimit = model.outputTokenLimit || 0;

            let entry = {
                name,
                displayName,
                inputTokenLimit: inputLimit,
                outputTokenLimit: outputLimit,
                rpm: null,
                tpm: null,
                rpd: null,
                source: 'æœªçŸ¥',
                dailyMaxOutput: null,
            };

            // Step 1: Make a lightweight request and capture headers
            try {
                let resp;
                if (currentFormat === 'openai') {
                    const modelId = name.replace('models/', '');
                    resp = await apiFetch(`${currentBaseUrl}/chat/completions`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentApiKey}` },
                        body: JSON.stringify({ model: modelId, messages: [{ role: 'user', content: 'Hi' }], max_tokens: 1 })
                    });
                } else {
                    resp = await apiFetch(`${currentBaseUrl}/${name}:generateContent?key=${currentApiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: 'Hi' }] }], generationConfig: { maxOutputTokens: 1 } })
                    });
                }

                const headerInfo = parseRateLimitHeaders(resp.headers);
                if (headerInfo.rpm != null) {
                    entry.rpm = headerInfo.rpm;
                    entry.source = 'API å“åº”å¤´';
                }
                if (headerInfo.tpm != null) entry.tpm = headerInfo.tpm;
                if (headerInfo.rpd != null) entry.rpd = headerInfo.rpd;
            } catch (err) {
                // Ignore, will use fallback
            }

            // Step 2: Fallback to known limits
            if (entry.rpm === null) {
                const known = getKnownLimits(name);
                if (known) {
                    entry.rpm = known.rpm;
                    entry.tpm = known.tpm;
                    entry.rpd = known.rpd;
                    entry.source = known.source;
                }
            }

            // Step 3: Calculate daily max output
            const rpd = entry.rpd || 0;
            const tpm = entry.tpm || 0;

            const dailyByRpd = rpd ? rpd * outputLimit : null;
            const dailyByTpm = tpm ? tpm * 1440 : null;

            if (dailyByRpd && dailyByTpm) {
                entry.dailyMaxOutput = Math.min(dailyByRpd, dailyByTpm);
            } else if (dailyByRpd) {
                entry.dailyMaxOutput = dailyByRpd;
            } else if (dailyByTpm) {
                entry.dailyMaxOutput = dailyByTpm;
            }

            return entry;
        }

        // Render the quota comparison table
        function renderQuotaTable() {
            const wrapper = document.getElementById('quotaTableWrapper');
            const tbody = document.getElementById('quotaTableBody');
            const calc = document.getElementById('tokenCalculator');
            const note = document.getElementById('quotaNote');

            if (!quotaData.length) {
                wrapper.style.display = 'none';
                calc.style.display = 'none';
                note.style.display = 'none';
                return;
            }

            const maxDaily = quotaData[0]?.dailyMaxOutput || 1;
            const medals = ['ğŸ¥‡', 'ğŸ¥ˆ', 'ğŸ¥‰'];

            tbody.innerHTML = quotaData.map((entry, idx) => {
                const rank = idx + 1;
                const medal = idx < 3 ? `<span class="rank-medal">${medals[idx]}</span>` : '';
                const rankClass = idx === 0 ? 'top1' : idx === 1 ? 'top2' : idx === 2 ? 'top3' : '';

                const barWidth = entry.dailyMaxOutput
                    ? Math.max(4, Math.round((entry.dailyMaxOutput / maxDaily) * 80))
                    : 0;
                const barColor = idx === 0 ? '#fdd663' : idx === 1 ? '#c0c0c0' : idx === 2 ? '#cd7f32' : '#4285f4';

                const sourceClass = entry.source.includes('API') ? 'api' : '';

                return `<tr>
                    <td>${medal}<span class="rank-num ${rankClass}">${rank}</span></td>
                    <td class="model-name-cell">${escapeHtml(entry.displayName)}</td>
                    <td class="num">${entry.rpm ?? '?'}</td>
                    <td class="num">${entry.tpm ? formatNumber(entry.tpm) : '?'}</td>
                    <td class="num">${entry.rpd != null ? entry.rpd.toLocaleString() : '?'}</td>
                    <td class="num">${entry.outputTokenLimit ? formatNumber(entry.outputTokenLimit) : '?'}</td>
                    <td class="num">
                        <span class="daily-bar" style="width:${barWidth}px;background:${barColor}"></span>
                        ${entry.dailyMaxOutput ? formatNumber(entry.dailyMaxOutput) : '?'}
                    </td>
                    <td><span class="quota-source ${sourceClass}">${escapeHtml(entry.source)}</span></td>
                </tr>`;
            }).join('');

            wrapper.style.display = 'block';
            calc.style.display = 'block';
            note.style.display = 'block';
        }

        // Token calculator
        function setTokenPreset(value) {
            document.getElementById('tokenDemand').value = value.toLocaleString();
            calculateTokenDemand();
        }

        function parseTokenInput(raw) {
            raw = raw.toUpperCase().replace(/,/g, '').replace(/\s/g, '').replace(/_/g, '');
            if (raw.endsWith('B')) return parseFloat(raw.slice(0, -1)) * 1e9;
            if (raw.endsWith('M')) return parseFloat(raw.slice(0, -1)) * 1e6;
            if (raw.endsWith('K')) return parseFloat(raw.slice(0, -1)) * 1e3;
            return parseFloat(raw);
        }

        function formatTime(days) {
            if (days < 1 / 24) {
                const minutes = days * 24 * 60;
                return { text: `~${Math.round(minutes)} åˆ†é’Ÿ`, cls: 'time-fast' };
            }
            if (days < 1) {
                const hours = days * 24;
                return { text: `~${hours.toFixed(1)} å°æ—¶`, cls: 'time-fast' };
            }
            if (days < 3) {
                return { text: `~${days.toFixed(1)} å¤©`, cls: 'time-medium' };
            }
            if (days < 7) {
                return { text: `~${days.toFixed(1)} å¤©`, cls: 'time-slow' };
            }
            return { text: `~${Math.round(days)} å¤© (${(days / 7).toFixed(1)} å‘¨)`, cls: 'time-very-slow' };
        }

        function calculateTokenDemand() {
            const raw = document.getElementById('tokenDemand').value.trim();
            if (!raw) return;

            const totalTokens = parseTokenInput(raw);
            if (isNaN(totalTokens) || totalTokens <= 0) return;

            const resultsDiv = document.getElementById('calcResults');
            const tbody = document.getElementById('calcResultBody');

            const rows = quotaData
                .filter(e => e.dailyMaxOutput && e.dailyMaxOutput > 0)
                .map(entry => {
                    const days = totalTokens / entry.dailyMaxOutput;
                    const outputPerReq = entry.outputTokenLimit || 1;
                    const numRequests = Math.ceil(totalTokens / outputPerReq);
                    const time = formatTime(days);

                    return `<tr>
                        <td style="font-weight:600;">${escapeHtml(entry.displayName)}</td>
                        <td class="num">${formatNumber(entry.dailyMaxOutput)}/å¤©</td>
                        <td class="num ${time.cls}">${time.text}</td>
                        <td class="num">${numRequests.toLocaleString()}</td>
                    </tr>`;
                });

            tbody.innerHTML = rows.join('');
            resultsDiv.classList.add('show');
        }

        // Show account diagnosis
        async function showAccountDiagnosis() {
            const section = document.getElementById('accountSection');
            const content = document.getElementById('accountContent');
            const desc = document.getElementById('accountDesc');

            desc.textContent = `${currentProvider?.icon || ''} ${currentProvider?.name || ''} è´¦æˆ·è¯Šæ–­`;
            section.style.display = 'block';

            let html = '';

            // 1. Balance
            const balInfo = await queryBalance();
            if (balInfo && balInfo.balance != null) {
                const sym = {CNY:'Â¥', USD:'$', EUR:'â‚¬'}[balInfo.currency] || (balInfo.currency + ' ');
                const balStr = `${sym}${balInfo.balance.toFixed(2)}`;
                if (balInfo.balance <= 0) {
                    html += diagItem('fail', 'âœ—', 'è´¦æˆ·ä½™é¢', balStr, 'ä½™é¢ä¸ºé›¶ï¼è¯·å‰å¾€å¹³å°å……å€¼åå†ä½¿ç”¨');
                } else if (balInfo.balance < 1) {
                    html += diagItem('warn', 'âš ', 'è´¦æˆ·ä½™é¢', balStr, 'ä½™é¢è¾ƒä½ï¼Œå»ºè®®åŠæ—¶å……å€¼');
                } else {
                    html += diagItem('ok', 'âœ“', 'è´¦æˆ·ä½™é¢', balStr);
                }
            } else if (balInfo && balInfo.available != null) {
                html += diagItem(balInfo.available ? 'ok' : 'fail',
                    balInfo.available ? 'âœ“' : 'âœ—', 'è´¦æˆ·çŠ¶æ€',
                    balInfo.available ? 'å¯ç”¨' : 'ä¸å¯ç”¨',
                    balInfo.available ? '' : 'è¯·æ£€æŸ¥è´¦æˆ·ä½™é¢æˆ–çŠ¶æ€');
            } else {
                html += diagItem('info', 'â„¹', 'è´¦æˆ·ä½™é¢', 'æ— æ³•æŸ¥è¯¢ (è¯¥å¹³å°å¯èƒ½ä¸æ”¯æŒä½™é¢æŸ¥è¯¢æ¥å£)');
            }

            // 2. Model availability summary
            const testBtns = document.querySelectorAll('.btn-test-model');
            const okCount = document.querySelectorAll('.btn-test-model.test-success').length;
            const failCount = document.querySelectorAll('.btn-test-model.test-fail').length;
            const total = okCount + failCount;

            if (total > 0) {
                if (okCount === 0) {
                    html += diagItem('fail', 'âœ—', 'æ¨¡å‹å¯ç”¨æ€§', `0/${total} å¯ç”¨`, 'æ‰€æœ‰æ¨¡å‹å‡ä¸å¯ç”¨ï¼Œé€šå¸¸æ˜¯ä½™é¢ä¸è¶³æˆ–å¯†é’¥æƒé™é—®é¢˜');
                } else if (failCount > okCount) {
                    html += diagItem('warn', 'âš ', 'æ¨¡å‹å¯ç”¨æ€§', `${okCount}/${total} å¯ç”¨`, 'è¾ƒå¤šæ¨¡å‹ä¸å¯ç”¨ï¼Œå¯èƒ½æ˜¯å¥—é¤é™åˆ¶æˆ–æ¨¡å‹æœªå¼€é€š');
                } else {
                    html += diagItem('ok', 'âœ“', 'æ¨¡å‹å¯ç”¨æ€§', `${okCount}/${total} å¯ç”¨`);
                }
            }

            // 3. Error analysis
            const errorGroups = {};
            document.querySelectorAll('.btn-test-model.test-fail').forEach(btn => {
                const reason = btn.textContent.replace(/^âœ—\s*/, '').trim();
                const modelName = (btn.dataset.model || '').replace('models/', '');
                if (!errorGroups[reason]) errorGroups[reason] = [];
                errorGroups[reason].push(modelName);
            });

            if (Object.keys(errorGroups).length > 0) {
                html += '<div class="error-group"><h4>ğŸ“‹ é”™è¯¯åŸå› åˆ†æ</h4>';
                const sorted = Object.entries(errorGroups).sort((a,b) => b[1].length - a[1].length);
                for (const [reason, models] of sorted) {
                    const examples = models.slice(0, 3).join(', ') + (models.length > 3 ? ` ç­‰ ${models.length} ä¸ªæ¨¡å‹` : '');
                    html += `<div class="error-group-item"><span class="error-group-reason">${escapeHtml(reason)}</span><span class="error-group-models">${escapeHtml(examples)}</span></div>`;
                }
                html += '</div>';
            }

            content.innerHTML = html;
        }

        function diagItem(type, icon, label, value, hint) {
            return `<div class="diag-item diag-${type}">
                <span class="diag-icon">${icon}</span>
                <span class="diag-label">${label}</span>
                <div><span class="diag-value">${escapeHtml(String(value))}</span>
                ${hint ? `<div class="diag-hint">${escapeHtml(hint)}</div>` : ''}</div>
            </div>`;
        }

        // Show quota section when models are loaded
        function showQuotaSection() {
            const hasGenModels = allModels.some(m =>
                (m.supportedGenerationMethods || []).includes('generateContent'));
            if (hasGenModels) {
                document.getElementById('quotaSection').classList.add('show');
            }
        }
    </script>
</body>
</html>
